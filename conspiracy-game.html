<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Conspiracy Theory Game ‚Äî Braeden Pope</title>
  <meta name="description" content="Play the Waterdeep Conspiracy Theory Game - A fun D&D campaign game." />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .game-container {
      max-width: 1200px;
      width: 100%;
      padding: 20px;
      text-align: center;
      margin: 0 auto;
    }

    .game-title {
      font-size: 2.5em;
      margin-bottom: 30px;
      color: var(--brand);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .screen {
      display: none;
      animation: slideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .screen.active {
      display: block;
    }

    .screen.exiting {
      animation: slideOut 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideIn {
      from { 
        opacity: 0; 
        transform: translateX(50px);
        filter: blur(5px);
      }
      to { 
        opacity: 1; 
        transform: translateX(0);
        filter: blur(0);
      }
    }

    @keyframes slideOut {
      from { 
        opacity: 1; 
        transform: translateX(0);
        filter: blur(0);
      }
      to { 
        opacity: 0; 
        transform: translateX(-50px);
        filter: blur(5px);
      }
    }

    .transition-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(122, 162, 255, 0.1), rgba(24, 194, 156, 0.1));
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    .transition-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease-in-out;
    }

    .transition-text {
      font-size: 1.5em;
      color: var(--brand);
      text-align: center;
      background: rgba(0,0,0,0.8);
      padding: 20px 40px;
      border-radius: 15px;
      border: 2px solid var(--brand);
    }

    .screen-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid rgba(122, 162, 255, 0.2);
    }

    .screen-title {
      font-size: 2em;
      margin-bottom: 10px;
      color: var(--brand);
    }

    .screen-subtitle {
      font-size: 1.1em;
      color: var(--muted);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      margin: 20px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--brand), var(--accent));
      border-radius: 3px;
      transition: width 0.6s ease;
    }

    .lobby-code {
      font-size: 3em;
      background: rgba(122, 162, 255, 0.2);
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
      border: 2px solid var(--brand);
      font-family: monospace;
      letter-spacing: 0.2em;
    }

    .players-list {
      background: var(--card);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      min-height: 150px;
      border: 1px solid #1b1f2a;
    }

    .player-item {
      background: rgba(122, 162, 255, 0.2);
      margin: 10px;
      padding: 15px;
      border-radius: 8px;
      display: inline-block;
      min-width: 150px;
      border: 1px solid rgba(122, 162, 255, 0.3);
    }

    .prompt-display {
      background: var(--card);
      border-radius: 15px;
      padding: 30px;
      margin: 20px 0;
      font-size: 1.3em;
      line-height: 1.5;
      border: 2px solid rgba(122, 162, 255, 0.3);
    }

    .timer {
      font-size: 2em;
      color: #ff6b6b;
      margin: 20px 0;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(255,107,107,0.5);
    }

    .timer.warning {
      animation: pulse 1s infinite;
      color: #ff4757;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .answers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .answer-item {
      background: var(--card);
      border-radius: 10px;
      padding: 20px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .answer-item:hover {
      border-color: var(--brand);
      transform: translateY(-2px);
      background: rgba(122, 162, 255, 0.1);
    }

    .answer-item.voted {
      border-color: var(--accent);
      background: rgba(24, 194, 156, 0.2);
    }

    .answer-item.non-clickable {
      cursor: default;
    }

    .vote-count {
      font-size: 1.5em;
      color: var(--brand);
      font-weight: bold;
      margin-top: 10px;
    }

    .game-btn {
      background: linear-gradient(45deg, var(--brand), #5a8aff);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      margin: 10px;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .game-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(122, 162, 255, 0.3);
    }

    .game-btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.6;
    }

    .game-btn.success {
      background: linear-gradient(45deg, var(--accent), #44a08d);
      color: white;
    }

    .input-field {
      padding: 15px;
      border-radius: 10px;
      border: 2px solid var(--brand);
      background: rgba(255,255,255,0.1);
      color: var(--text);
      font-size: 1.1em;
      margin: 10px;
      width: 300px;
      transition: border-color 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.15);
    }

    .input-field::placeholder {
      color: rgba(232, 236, 241, 0.7);
    }

    .scoreboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .score-item {
      background: rgba(122, 162, 255, 0.2);
      border-radius: 10px;
      padding: 20px;
      border: 2px solid var(--brand);
      position: relative;
    }

    .score-item.winner {
      border-color: var(--accent);
      background: rgba(24, 194, 156, 0.3);
    }

    .score-item.winner::before {
      content: "üëë";
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 2em;
    }

    .score-name {
      font-size: 1.3em;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .score-points {
      font-size: 2em;
      color: var(--accent);
      font-weight: bold;
    }

    .mobile-input {
      width: 100%;
      max-width: 500px;
      margin: 20px auto;
    }

    .mobile-input textarea {
      width: 100%;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid var(--brand);
      background: rgba(255,255,255,0.1);
      color: var(--text);
      font-size: 1.1em;
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    .mobile-input textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.15);
    }

    .mobile-input textarea::placeholder {
      color: rgba(232, 236, 241, 0.7);
    }

    .status-message {
      background: rgba(24, 194, 156, 0.2);
      border: 1px solid var(--accent);
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      color: var(--accent);
    }

    .error-message {
      background: rgba(255, 107, 107, 0.2);
      border: 1px solid #ff6b6b;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      color: #ff6b6b;
    }

    .round-info {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      font-size: 1.2em;
    }

    .waiting-indicator {
      display: inline-block;
      animation: spin 1s infinite linear;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .game-title {
        font-size: 1.8em;
      }
      
      .lobby-code {
        font-size: 2em;
      }
      
      .input-field {
        width: 250px;
      }
      
      .answers-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .game-title {
        font-size: 1.5em;
      }
      
      .lobby-code {
        font-size: 1.5em;
        padding: 15px;
      }
      
      .input-field {
        width: 90%;
      }
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav><div class="container nav-inner"><div class="brand"><a href="index.html">Braeden Pope</a></div><ul class="nav-links"><li><a data-page="index.html" href="index.html">Home</a></li><li><a data-page="projects.html" href="projects.html">Projects</a></li><li><a data-page="about.html" href="about.html">About</a></li>        <li><a data-page="contact.html" href="contact.html">Contact</a></li><li><a data-page="conspiracy-game.html" href="conspiracy-game.html">Game</a></li></ul></div></nav>

  <div class="container">
    <div class="game-container">
      <h1 class="game-title">üïµÔ∏è Waterdeep Conspiracy Theories üïµÔ∏è</h1>
      
      <!-- Transition Overlay -->
      <div class="transition-overlay" id="transition-overlay">
        <div class="transition-text" id="transition-text">Loading...</div>
      </div>
      
      <!-- Screen 1: Home Screen -->
      <div id="home-screen" class="screen active">
        <div class="screen-header">
          <div class="screen-title">Welcome to the Game!</div>
          <div class="screen-subtitle">Create wild conspiracy theories about your D&D campaign</div>
        </div>
        <div style="margin-bottom: 30px;">
          <p style="font-size: 1.1em; margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto;">
            Join up to 8 players in this hilarious party game where you create the most outrageous conspiracy theories about your campaign characters and vote for the best ones!
          </p>
        </div>
        <button class="game-btn" onclick="showHostLobby()">üéÆ Host Game</button>
        <button class="game-btn" onclick="showJoinScreen()">üì± Join Game</button>
      </div>

      <!-- Screen 2: Join Screen -->
      <div id="join-screen" class="screen">
        <div class="screen-header">
          <div class="screen-title">Join a Game</div>
          <div class="screen-subtitle">Enter the room code to join your friends</div>
        </div>
        <input type="text" id="room-code" class="input-field" placeholder="Enter Room Code" maxlength="4" style="text-transform: uppercase;">
        <br>
        <input type="text" id="player-name" class="input-field" placeholder="Enter Your Name" maxlength="20">
        <br>
        <button class="game-btn" onclick="joinGame()">Join Game</button>
        <button class="game-btn" onclick="showHomeScreen()">Back</button>
        <div id="join-error" class="error-message" style="display: none;"></div>
      </div>

      <!-- Screen 3: Game Lobby -->
      <div id="lobby-screen" class="screen">
        <div class="screen-header">
          <div class="screen-title">Game Lobby</div>
          <div class="screen-subtitle" id="lobby-subtitle">Waiting for players to join...</div>
        </div>
        
        <!-- Host View -->
        <div id="host-lobby-content" style="display: none;">
          <div class="lobby-code" id="lobby-code">ABCD</div>
          <p style="margin: 10px 0;">Share this code with players or send them this link:<br>
          <strong id="game-url">Loading...</strong></p>
        </div>
        
        <!-- Player View -->
        <div id="player-lobby-content" style="display: none;">
          <div class="status-message">
            <p><strong>Room Code:</strong> <span id="player-room-code"></span></p>
            <p><strong>Your Name:</strong> <span id="player-display-name"></span></p>
          </div>
        </div>
        
        <div class="players-list">
          <h3>Players in Game (<span id="lobby-player-count">0</span>):</h3>
          <div id="players-container">
            <p style="color: #888;">Waiting for players to join...</p>
          </div>
        </div>
        
        <button class="game-btn" onclick="startGame()" id="start-game-btn" style="display: none;">Start Game</button>
        <button class="game-btn" onclick="showHomeScreen()">Leave Game</button>
      </div>

      <!-- Screen 4: Writing Phase -->
      <div id="writing-screen" class="screen">
        <div class="screen-header">
          <div class="screen-title">Round <span id="current-round">1</span> of 4</div>
          <div class="screen-subtitle">Write your conspiracy theory!</div>
        </div>
        
        <div class="progress-bar">
          <div class="progress-fill" id="game-progress" style="width: 25%;"></div>
        </div>
        
        <div class="prompt-display" id="writing-prompt">Loading prompt...</div>
        
        <div class="timer" id="writing-timer">60</div>
        
        <!-- Host View -->
        <div id="host-writing-content" style="display: none;">
          <div class="status-message">
            <p><span class="waiting-indicator">‚è≥</span> Players are writing their theories...</p>
            <p><strong>Submitted:</strong> <span id="submitted-count">0</span>/<span id="total-players">0</span></p>
          </div>
          <button class="game-btn" onclick="skipTimer()">Skip Timer ‚è≠Ô∏è</button>
        </div>
        
        <!-- Player View -->
        <div id="player-writing-content" style="display: none;">
          <div class="mobile-input">
            <textarea id="conspiracy-input" placeholder="Write your conspiracy theory here... Be creative and funny!"></textarea>
            <br>
            <button class="game-btn" onclick="submitConspiracy()" id="submit-btn">Submit Theory</button>
          </div>
        </div>
      </div>

      <!-- Screen 5: Voting Phase -->
      <div id="voting-screen" class="screen">
        <div class="screen-header">
          <div class="screen-title">Vote for the Best Theory!</div>
          <div class="screen-subtitle">Choose your favorite conspiracy (you can't vote for your own)</div>
        </div>
        
        <div class="progress-bar">
          <div class="progress-fill" id="voting-progress" style="width: 50%;"></div>
        </div>
        
        <div class="answers-grid" id="voting-answers-grid"></div>
        
        <div class="status-message" id="voting-status">
          <p><span class="waiting-indicator">‚è≥</span> Waiting for all players to vote...</p>
          <p><strong>Voted:</strong> <span id="voted-count">0</span>/<span id="total-players-voting">0</span></p>
        </div>
      </div>

      <!-- Screen 6: Vote Results -->
      <div id="vote-results-screen" class="screen">
        <div class="screen-header">
          <div class="screen-title">Round Results</div>
          <div class="screen-subtitle">See how everyone voted!</div>
        </div>
        
        <div class="progress-bar">
          <div class="progress-fill" id="results-progress" style="width: 75%;"></div>
        </div>
        
        <div class="answers-grid" id="vote-results-grid"></div>
        
        <!-- Host controls -->
        <div id="host-results-controls" style="display: none;">
          <button class="game-btn" onclick="showCurrentScores()" id="show-scores-btn">Show Scores üìä</button>
        </div>
        
        <!-- Player waiting -->
        <div id="player-results-waiting" style="display: none;">
          <div class="status-message">
            <p><span class="waiting-indicator">‚è≥</span> Waiting for next round...</p>
          </div>
        </div>
      </div>

      <!-- Screen 7: Current Scores -->
      <div id="current-scores-screen" class="screen">
        <div class="screen-header">
          <div class="screen-title">Current Scores</div>
          <div class="screen-subtitle">After Round <span id="scores-round">1</span></div>
        </div>
        
        <div class="progress-bar">
          <div class="progress-fill" id="scores-progress" style="width: 75%;"></div>
        </div>
        
        <div class="scoreboard" id="current-scoreboard"></div>
        
        <div id="host-scores-controls" style="display: none;">
          <button class="game-btn" id="continue-game-btn" onclick="continueGame()">Continue Game ‚û°Ô∏è</button>
        </div>
        
        <div id="player-scores-waiting" style="display: none;">
          <div class="status-message">
            <p><span class="waiting-indicator">‚è≥</span> Get ready for the next round...</p>
          </div>
        </div>
      </div>

      <!-- Screen 8: Final Results -->
      <div id="final-results-screen" class="screen">
        <div class="screen-header">
          <div class="screen-title">üèÜ Final Results üèÜ</div>
          <div class="screen-subtitle">Game Over - Here's who won!</div>
        </div>
        
        <div class="progress-bar">
          <div class="progress-fill" style="width: 100%;"></div>
        </div>
        
        <div class="scoreboard" id="final-scoreboard"></div>
        
        <div class="status-message">
          <p>Thanks for playing! üéâ</p>
          <p>Want to play another round?</p>
        </div>
        
        <button class="game-btn" onclick="resetGame()">üéÆ New Game</button>
        <button class="game-btn" onclick="showHomeScreen()">Main Menu</button>
      </div>
    </div>
  </div>

  <footer><div class="container small">¬© <span id="y"></span> Braeden Pope</div></footer>
  <script src="script.js"></script>
  <script>document.getElementById('y').textContent=new Date().getFullYear()</script>
  
  <!-- Socket.io will be loaded from CDN since we can't use the /socket.io/ path in a static site -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    let socket;
    let gameState = {
      isHost: false,
      lobbyCode: '',
      playerName: '',
      playerId: '',
      currentRound: 1,
      maxRounds: 4,
      currentPrompt: '',
      hasSubmitted: false,
      hasVoted: false,
      connected: false
    };

    // Initialize socket connection
    function initSocket() {
      // Replace this URL with your deployed server URL
      const serverUrl = 'https://portfolio-quge.onrender.com'; // Change this!
      socket = io(serverUrl);
      
      socket.on('connect', () => {
        console.log('Connected to server');
        gameState.connected = true;
        gameState.playerId = socket.id;
        hideError();
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from server');
        gameState.connected = false;
      });

      // Game events
      socket.on('gameCreated', ({ code }) => {
        console.log('Game created with code:', code);
        gameState.lobbyCode = code;
        
        // Make sure we update the display
        const lobbyCodeElement = document.getElementById('lobby-code');
        if (lobbyCodeElement) {
          lobbyCodeElement.textContent = code;
        }
        
        document.getElementById('game-url').textContent = window.location.origin + '/conspiracy-game.html';
        updateStartButton(0); // Start with 0 players
        hideTransition();
      });

      socket.on('joinedGame', ({ code }) => {
        console.log('Successfully joined game:', code);
        gameState.lobbyCode = code;
        document.getElementById('player-room-code').textContent = code;
        document.getElementById('player-display-name').textContent = gameState.playerName;
        showPlayerLobby();
        hideError();
      });

      socket.on('playersUpdate', ({ players }) => {
        updatePlayersDisplay(players);
        updateStartButton(players.length);
      });

      socket.on('roundStart', ({ round, prompt, timeLeft }) => {
        gameState.currentRound = round;
        gameState.currentPrompt = prompt;
        gameState.hasSubmitted = false;
        gameState.hasVoted = false;
        
        document.getElementById('current-round').textContent = round;
        document.getElementById('writing-prompt').textContent = prompt;
        
        showWritingScreen();
        updateTimer(timeLeft);
      });

      socket.on('timerUpdate', ({ timeLeft }) => {
        updateTimer(timeLeft);
      });

      socket.on('submissionUpdate', ({ submitted, total }) => {
        document.getElementById('submitted-count').textContent = submitted;
        document.getElementById('total-players').textContent = total;
      });

      socket.on('votingPhase', ({ submissions }) => {
        showVotingScreen();
        displayAnswersForVoting(submissions);
      });

      socket.on('voteUpdate', ({ voted, total }) => {
        document.getElementById('voted-count').textContent = voted;
        document.getElementById('total-players-voting').textContent = total;
      });

      socket.on('results', ({ results, isLastRound }) => {
        showVoteResultsScreen();
        displayVoteResults(results);
        gameState.isLastRound = isLastRound;
      });

      socket.on('finalResults', ({ scores }) => {
        showFinalResultsScreen();
        displayFinalResults(scores);
      });

      socket.on('theorySubmitted', () => {
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.textContent = '‚úÖ Theory Submitted!';
        submitBtn.classList.add('success');
        submitBtn.disabled = true;
        document.getElementById('conspiracy-input').disabled = true;
        gameState.hasSubmitted = true;
      });

      socket.on('voteRegistered', () => {
        const statusDiv = document.getElementById('voting-status');
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '‚úÖ Your vote has been registered!';
        gameState.hasVoted = true;
      });

      socket.on('error', (message) => {
        showError(message);
        console.error('Game error:', message);
      });
    }

    // Enhanced screen transition system
    function showScreen(screenId, transitionText = '') {
      // Show transition overlay if text provided
      if (transitionText) {
        showTransition(transitionText);
        setTimeout(() => {
          performScreenTransition(screenId);
          hideTransition();
        }, 800);
      } else {
        performScreenTransition(screenId);
      }
    }

    function performScreenTransition(screenId) {
      const currentScreen = document.querySelector('.screen.active');
      const newScreen = document.getElementById(screenId);
      
      if (currentScreen) {
        currentScreen.classList.remove('active');
        currentScreen.classList.add('exiting');
        setTimeout(() => {
          currentScreen.classList.remove('exiting');
        }, 400);
      }
      
      if (newScreen) {
        newScreen.classList.add('active');
      }
    }

    function showTransition(text) {
      const overlay = document.getElementById('transition-overlay');
      const textElement = document.getElementById('transition-text');
      textElement.textContent = text;
      overlay.classList.add('active');
    }

    function hideTransition() {
      const overlay = document.getElementById('transition-overlay');
      overlay.classList.remove('active');
    }

    function updateProgressBar(stage) {
      const progressBars = {
        'writing': 25,
        'voting': 50,
        'results': 75,
        'final': 100
      };
      
      ['game-progress', 'voting-progress', 'results-progress', 'scores-progress'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.style.width = (progressBars[stage] || 0) + '%';
        }
      });
    }

    // Screen navigation functions
    function showHomeScreen() {
      showScreen('home-screen');
      if (socket && socket.connected) {
        socket.disconnect();
      }
      resetGameState();
    }

    function showJoinScreen() {
      showScreen('join-screen');
    }

    function showHostLobby() {
      gameState.isHost = true;
      // Clear any previous lobby code
      document.getElementById('lobby-code').textContent = 'LOADING...';
      
      initSocket();
      showScreen('lobby-screen', 'Creating game...');
      
      // Show host content
      document.getElementById('host-lobby-content').style.display = 'block';
      document.getElementById('player-lobby-content').style.display = 'none';
      document.getElementById('start-game-btn').style.display = 'block';
      document.getElementById('lobby-subtitle').textContent = 'Share the room code with your friends';
      
      // Wait for socket connection before creating game
      const waitForConnection = () => {
        if (gameState.connected) {
          console.log('Socket connected, creating game...');
          socket.emit('createGame');
        } else {
          setTimeout(waitForConnection, 100);
        }
      };
      waitForConnection();
    }

    function showPlayerLobby() {
      showScreen('lobby-screen', 'Joining game...');
      
      // Show player content
      document.getElementById('host-lobby-content').style.display = 'none';
      document.getElementById('player-lobby-content').style.display = 'block';
      document.getElementById('start-game-btn').style.display = 'none';
      document.getElementById('lobby-subtitle').textContent = 'Waiting for host to start the game';
    }

    function showWritingScreen() {
      showScreen('writing-screen', 'Get ready to write...');
      updateProgressBar('writing');
      
      if (gameState.isHost) {
        document.getElementById('host-writing-content').style.display = 'block';
        document.getElementById('player-writing-content').style.display = 'none';
      } else {
        document.getElementById('host-writing-content').style.display = 'none';
        document.getElementById('player-writing-content').style.display = 'block';
        resetWritingInterface();
      }
    }

    function showVotingScreen() {
      showScreen('voting-screen', 'Time to vote!');
      updateProgressBar('voting');
    }

    function showVoteResultsScreen() {
      showScreen('vote-results-screen', 'Counting votes...');
      updateProgressBar('results');
      
      if (gameState.isHost) {
        document.getElementById('host-results-controls').style.display = 'block';
        document.getElementById('player-results-waiting').style.display = 'none';
      } else {
        document.getElementById('host-results-controls').style.display = 'none';
        document.getElementById('player-results-waiting').style.display = 'block';
      }
    }

    function showCurrentScores() {
      showScreen('current-scores-screen', 'Calculating scores...');
      
      document.getElementById('scores-round').textContent = gameState.currentRound;
      
      if (gameState.isHost) {
        document.getElementById('host-scores-controls').style.display = 'block';
        document.getElementById('player-scores-waiting').style.display = 'none';
        
        // Update button text based on if it's the last round
        const continueBtn = document.getElementById('continue-game-btn');
        if (gameState.currentRound >= gameState.maxRounds) {
          continueBtn.textContent = 'Show Final Results üèÜ';
          continueBtn.onclick = () => socket.emit('nextRound', { code: gameState.lobbyCode });
        } else {
          continueBtn.textContent = `Start Round ${gameState.currentRound + 1} ‚û°Ô∏è`;
          continueBtn.onclick = continueGame;
        }
      } else {
        document.getElementById('host-scores-controls').style.display = 'none';
        document.getElementById('player-scores-waiting').style.display = 'block';
      }
    }

    function showFinalResultsScreen() {
      showScreen('final-results-screen', 'Game complete!');
      updateProgressBar('final');
    }

    function continueGame() {
      if (gameState.connected && gameState.lobbyCode) {
        socket.emit('nextRound', { code: gameState.lobbyCode });
      }
    }

    function resetGameState() {
      gameState = {
        isHost: false,
        lobbyCode: '',
        playerName: '',
        playerId: '',
        currentRound: 1,
        maxRounds: 4,
        currentPrompt: '',
        hasSubmitted: false,
        hasVoted: false,
        connected: false
      };
    }

    function showError(message) {
      const errorDiv = document.getElementById('join-error');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }
    }

    function hideError() {
      const errorDiv = document.getElementById('join-error');
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
    }

    // Host functions
    function showHostView() {
      gameState.isHost = true;
      showScreen('host-view');
      showHostScreen('host-lobby');
      initSocket();
    }

    function startGame() {
      if (gameState.connected && gameState.lobbyCode) {
        socket.emit('startGame', { code: gameState.lobbyCode });
      } else {
        showError('Not connected to server or no game created');
      }
    }

    function nextRound() {
      if (gameState.connected && gameState.lobbyCode) {
        socket.emit('nextRound', { code: gameState.lobbyCode });
      }
    }

    function skipTimer() {
      if (gameState.connected && gameState.lobbyCode) {
        socket.emit('skipTimer', { code: gameState.lobbyCode });
      }
    }

    function resetGame() {
      showHostLobby();
    }

    // Player functions
    function joinGame() {
      const code = document.getElementById('room-code').value.toUpperCase().trim();
      const name = document.getElementById('player-name').value.trim();
      
      console.log('Attempting to join game:', { code, name });
      
      if (!code || !name) {
        showError('Please enter both room code and your name!');
        return;
      }
      
      if (code.length !== 4) {
        showError('Room code must be exactly 4 characters!');
        return;
      }
      
      if (name.length > 20) {
        showError('Name must be 20 characters or less!');
        return;
      }
      
      gameState.playerName = name;
      gameState.isHost = false;
      
      // Show loading state
      showTransition('Joining game...');
      
      initSocket();
      
      // Wait for socket connection before joining
      const waitForConnection = () => {
        if (gameState.connected) {
          console.log('Socket connected, attempting to join...');
          socket.emit('joinGame', { code, name });
        } else {
          console.log('Waiting for socket connection...');
          setTimeout(waitForConnection, 100);
        }
      };
      waitForConnection();
    }

    function resetWritingInterface() {
      const input = document.getElementById('conspiracy-input');
      const btn = document.getElementById('submit-btn');
      
      input.value = '';
      input.disabled = false;
      btn.disabled = false;
      btn.textContent = 'Submit Theory';
      btn.classList.remove('success');
    }

    function submitConspiracy() {
      const theory = document.getElementById('conspiracy-input').value.trim();
      if (!theory) {
        alert('Please write a conspiracy theory!');
        return;
      }
      
      if (gameState.connected && gameState.lobbyCode) {
        socket.emit('submitTheory', { code: gameState.lobbyCode, theory });
      }
    }

    function voteForAnswer(playerId) {
      if (gameState.hasVoted || playerId === gameState.playerId) {
        return;
      }
      
      if (gameState.connected && gameState.lobbyCode) {
        socket.emit('vote', { code: gameState.lobbyCode, votedForId: playerId });
        
        // Update UI immediately
        document.querySelectorAll('.answer-item[data-id]').forEach(el => {
          el.classList.remove('voted');
          el.classList.add('non-clickable');
          el.onclick = null;
        });
        
        const votedElement = document.querySelector(`[data-id="${playerId}"]`);
        if (votedElement) {
          votedElement.classList.add('voted');
        }
      }
    }

    // Enhanced display functions
    function updatePlayersDisplay(players = []) {
      const container = document.getElementById('players-container');
      const countElement = document.getElementById('lobby-player-count');
      
      if (players.length === 0) {
        container.innerHTML = '<p style="color: #888;">Waiting for players to join...</p>';
      } else {
        const playerElements = players.map(player => 
          `<div class="player-item">${player.name}</div>`
        ).join('');
        container.innerHTML = playerElements;
      }
      
      if (countElement) countElement.textContent = players.length;
    }

    function updateStartButton(playerCount = 0) {
      const startBtn = document.getElementById('start-game-btn');
      if (gameState.isHost && startBtn) {
        if (playerCount >= 1) {
          startBtn.disabled = false;
          startBtn.textContent = `Start Game (${playerCount} player${playerCount !== 1 ? 's' : ''})`;
        } else {
          startBtn.disabled = true;
          startBtn.textContent = 'Waiting for players...';
        }
      }
    }

    function updateTimer(timeLeft) {
      const timerElement = document.getElementById('writing-timer');
      
      if (timerElement) {
        timerElement.textContent = timeLeft;
        if (timeLeft <= 10) {
          timerElement.classList.add('warning');
        } else {
          timerElement.classList.remove('warning');
        }
      }
    }

    function displayAnswersForVoting(submissions) {
      const grid = document.getElementById('voting-answers-grid');
      
      const playerHTML = submissions.map(sub => {
        const isOwnTheory = sub.id === gameState.playerId;
        const clickHandler = isOwnTheory ? '' : `onclick="voteForAnswer('${sub.id}')"`;
        const className = isOwnTheory ? 'answer-item non-clickable' : 'answer-item';
        const ownTheoryLabel = isOwnTheory ? '<div style="color: var(--accent); font-weight: bold; margin-bottom: 5px;">Your Theory</div>' : '';
        
        return `<div class="${className}" ${clickHandler} data-id="${sub.id}">
          ${ownTheoryLabel}
          <div style="font-size: 1.1em;">${sub.text}</div>
        </div>`;
      }).join('');
      
      if (grid) grid.innerHTML = playerHTML;
    }

    function displayVoteResults(results) {
      const grid = document.getElementById('vote-results-grid');
      
      const resultsHTML = results.map(result => 
        `<div class="answer-item non-clickable">
          <div style="font-size: 1.1em; margin-bottom: 10px;">${result.text}</div>
          <div style="font-style: italic; color: var(--brand); margin-bottom: 10px;">by ${result.playerName}</div>
          <div class="vote-count">${result.votes} vote${result.votes !== 1 ? 's' : ''} ${result.votes > 0 ? 'üéâ' : ''}</div>
        </div>`
      ).join('');
      
      if (grid) grid.innerHTML = resultsHTML;
      
      // Create current scores after showing vote results
      setTimeout(() => {
        if (gameState.isHost) {
          calculateCurrentScores(results);
        }
      }, 2000);
    }

    function calculateCurrentScores(results) {
      // Calculate scores based on votes received
      const scoreUpdates = new Map();
      results.forEach(result => {
        scoreUpdates.set(result.id, result.votes);
      });
      
      // Update running totals
      scoreUpdates.forEach((votes, playerId) => {
        const currentScore = gameState.runningScores?.get(playerId) || 0;
        if (!gameState.runningScores) gameState.runningScores = new Map();
        gameState.runningScores.set(playerId, currentScore + votes);
      });
      
      // Display current scores
      displayCurrentScores();
    }

    function displayCurrentScores() {
      const scoreboard = document.getElementById('current-scoreboard');
      
      if (!gameState.runningScores) return;
      
      const scores = Array.from(gameState.runningScores.entries()).map(([id, score]) => {
        const playerName = gameState.playerNames?.get(id) || 'Unknown Player';
        return { id, name: playerName, score };
      }).sort((a, b) => b.score - a.score);
      
      const scoreboardHTML = scores.map((player, index) => {
        const isLeading = index === 0 && player.score > 0;
        const className = isLeading ? 'score-item winner' : 'score-item';
        
        return `<div class="${className}">
          <div class="score-name">
            ${isLeading ? 'üëë ' : ''}${player.name}
            ${isLeading ? ' - Leading!' : ''}
          </div>
          <div class="score-points">${player.score} point${player.score !== 1 ? 's' : ''}</div>
        </div>`;
      }).join('');
      
      if (scoreboard) scoreboard.innerHTML = scoreboardHTML;
    }

    function displayFinalResults(scores) {
      const scoreboard = document.getElementById('final-scoreboard');
      
      const scoreboardHTML = scores.map((player, index) => {
        const isWinner = index === 0;
        const className = isWinner ? 'score-item winner' : 'score-item';
        
        return `<div class="${className}">
          <div class="score-name">
            ${isWinner ? 'üèÜ ' : ''}${player.name}
            ${isWinner ? ' - WINNER!' : ''}
          </div>
          <div class="score-points">${player.score} point${player.score !== 1 ? 's' : ''}</div>
        </div>`;
      }).join('');
      
      if (scoreboard) scoreboard.innerHTML = scoreboardHTML;
    }

    // Auto-uppercase room code input
    document.addEventListener('DOMContentLoaded', () => {
      const roomCodeInput = document.getElementById('room-code');
      if (roomCodeInput) {
        roomCodeInput.addEventListener('input', (e) => {
          e.target.value = e.target.value.toUpperCase();
        });
      }
    });
  </script>
</body>
</html>